---
layout: post
title: "[In-The-Wild] CVE-2024-44308 : Apple Safari JavaScriptCore Remote Code Execution Vulnerability"
author: "Dohyun Lee (@l33d0hyun)"
---

# Summary
- CVE ID : [CVE-2024-44308](https://support.apple.com/en-us/121754/)
- Target Software : Apple Safari (iOS, visionOS, macOS)
- Affected Version : iOS 17.7.1, 18.1, visionOS 2.1, macOS Sequoia 15.1
- Patched Version : iOS 17.7.2, 18.1.1, visionOS 2.1.1, macOS Sequoia 15.1.1
- Impact : Remote Code Execution
- Reporter(s) : [Clément Lecigne](https://x.com/_clem1) and [Benoît Sevens](https://x.com/benoitsevens) of [Google's Threat Analysis Group](https://blog.google/threat-analysis-group/)
- Analyzer(s) : [Dohyun Lee (@l33d0hyun)](https://x.com/l33d0hyun) of [USELab, Korea University](https://sites.google.com/view/uselab-kus/home)

# Technical Details
## Overview
- This vulnerability in WebKit's DFG JIT compiler involves a register corruption issue due to improper allocation timing of `scratch2GPR` register.

## Analysis
- WebKit Commit : [53e7f27d262249310bd6b7ad452e7df334c92b7d](https://github.com/WebKit/WebKit/commit/53e7f27d262249310bd6b7ad452e7df334c92b7d).diff
    ```diff
    diff --git a/Source/JavaScriptCore/dfg/DFGSpeculativeJIT.cpp b/Source/JavaScriptCore/dfg/DFGSpeculativeJIT.cpp
    index 356d52b21a120..d041b63e8ba98 100644
    --- a/Source/JavaScriptCore/dfg/DFGSpeculativeJIT.cpp
    +++ b/Source/JavaScriptCore/dfg/DFGSpeculativeJIT.cpp
    @@ -3528,6 +3528,14 @@ void SpeculativeJIT::compilePutByValForIntTypedArray(Node* node, TypedArrayType
            }
        }
    
    +    GPRReg scratch2GPR = InvalidGPRReg;
    +#if USE(JSVALUE64)
    +    if (node->arrayMode().mayBeResizableOrGrowableSharedTypedArray()) {
    +        scratch2.emplace(this);
    +        scratch2GPR = scratch2->gpr();
    +    }
    +#endif
    +
        bool result = getIntTypedArrayStoreOperand(
            value, propertyReg,
    #if USE(JSVALUE32_64)
    @@ -3539,14 +3547,6 @@ void SpeculativeJIT::compilePutByValForIntTypedArray(Node* node, TypedArrayType
            return;
        }
    
    -    GPRReg scratch2GPR = InvalidGPRReg;
    -#if USE(JSVALUE64)
    -    if (node->arrayMode().mayBeResizableOrGrowableSharedTypedArray()) {
    -        scratch2.emplace(this);
    -        scratch2GPR = scratch2->gpr();
    -    }
    -#endif
    -
        GPRReg valueGPR = value.gpr();
        GPRReg scratchGPR = scratch.gpr();
    #if USE(JSVALUE32_64)
    ```

- This vulnerability has been patched as shown above. In the pre-patch code, there was a potential register usage issue where `scratch2GPR` was allocated after calling `getIntTypedArrayStoreOperand()`. This could lead to problems for the following reasons:

    - `scratch2GPR` is required for bounds checking of resizable/growable shared TypedArrays.
    - Register allocation occurs too late in the execution flow, causing unnecessary register allocation when `getIntTypedArrayStoreOperand()` fails.

- Code Flow:
  - Call `getIntTypedArrayStoreOperand()` -> If successful, allocate `scratch2GPR` -> Use `scratch2GPR` for bounds checking

## Proof-of-Concept (Unfinished)
- This is not a fully developed PoC, but it allows us to reach the functions we need to trigger: `SpeculativeJIT::compilePutByValForIntTypedArray` and `getIntTypedArrayStoreOperand()`.

    ```js
    var ab = new ArrayBuffer(8);
    var ibuf = new Int32Array(ab);

    function jitMe(arr) {
    for(let i = 0; i < 1000000; i++) {
        arr[(i & 0xffff)] = (i & 0xff);
    }
    return arr;
    }

    for(let i = 0; i < 100; i++) {
    jitMe(ibuf);
    }
    ```

- The complete PoC code will be updated once it is finalized.

## Additional Information
- I think I might find useful information on the blog below! It seems to have some similarities.
  - [https://blog.csdn.net/qq_61670993/article/details/137603280](https://blog.csdn.net/qq_61670993/article/details/137603280)